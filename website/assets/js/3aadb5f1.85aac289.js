"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6950],{1748:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>r,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var s=t(5893),o=t(1151);const a={id:"block-endpoint-edit-default-role",title:"Block Endpoint Edit Default Role"},r="Block Endpoint Edit Default Role",l={id:"validation/block-endpoint-edit-default-role",title:"Block Endpoint Edit Default Role",description:"Description",source:"@site/docs/validation/block-endpoint-edit-default-role.md",sourceDirName:"validation",slug:"/validation/block-endpoint-edit-default-role",permalink:"/gatekeeper-library/website/validation/block-endpoint-edit-default-role",draft:!1,unlisted:!1,editUrl:"https://github.com/open-policy-agent/gatekeeper-library/edit/master/website/docs/validation/block-endpoint-edit-default-role.md",tags:[],version:"current",frontMatter:{id:"block-endpoint-edit-default-role",title:"Block Endpoint Edit Default Role"},sidebar:"docs",previous:{title:"Automount Service Account Token for Pod",permalink:"/gatekeeper-library/website/validation/automount-serviceaccount-token"},next:{title:"Block Services with type LoadBalancer",permalink:"/gatekeeper-library/website/validation/block-loadbalancer-services"}},i={},c=[{value:"Description",id:"description",level:2},{value:"Template",id:"template",level:2},{value:"Usage",id:"usage",level:3},{value:"Examples",id:"examples",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,o.a)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"block-endpoint-edit-default-role",children:"Block Endpoint Edit Default Role"}),"\n",(0,s.jsx)(n.h2,{id:"description",children:"Description"}),"\n",(0,s.jsxs)(n.p,{children:["Many Kubernetes installations by default have a system",":aggregate-to-edit"," ClusterRole which does not properly restrict access to editing Endpoints. This ConstraintTemplate forbids the system",":aggregate-to-edit"," ClusterRole from granting permission to create/patch/update Endpoints.\nClusterRole/system",":aggregate-to-edit"," should not allow Endpoint edit permissions due to CVE-2021-25740, Endpoint & EndpointSlice permissions allow cross-Namespace forwarding, ",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes/kubernetes/issues/103675",children:"https://github.com/kubernetes/kubernetes/issues/103675"})]}),"\n",(0,s.jsx)(n.h2,{id:"template",children:"Template"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1\nkind: ConstraintTemplate\nmetadata:\n  name: k8sblockendpointeditdefaultrole\n  annotations:\n    metadata.gatekeeper.sh/title: "Block Endpoint Edit Default Role"\n    metadata.gatekeeper.sh/version: 1.0.0\n    description: >-\n      Many Kubernetes installations by default have a system:aggregate-to-edit\n      ClusterRole which does not properly restrict access to editing Endpoints.\n      This ConstraintTemplate forbids the system:aggregate-to-edit ClusterRole\n      from granting permission to create/patch/update Endpoints.\n\n      ClusterRole/system:aggregate-to-edit should not allow\n      Endpoint edit permissions due to CVE-2021-25740, Endpoint & EndpointSlice\n      permissions allow cross-Namespace forwarding,\n      https://github.com/kubernetes/kubernetes/issues/103675\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sBlockEndpointEditDefaultRole\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8sblockendpointeditdefaultrole\n\n        violation[{"msg": msg}] {\n            input.review.object.metadata.name == "system:aggregate-to-edit"\n            endpointRule(input.review.object.rules[_])\n            msg := "ClusterRole system:aggregate-to-edit should not allow endpoint edit permissions. For k8s version < 1.22, the Cluster Role should be annotated with rbac.authorization.kubernetes.io/autoupdate=false to prevent autoreconciliation back to default permissions for this role."\n        }\n\n        endpointRule(rule) {\n            "endpoints" == rule.resources[_]\n            hasEditVerb(rule.verbs)\n        }\n\n        hasEditVerb(verbs) {\n            "create" == verbs[_]\n        }\n\n        hasEditVerb(verbs) {\n            "patch" == verbs[_]\n        }\n\n        hasEditVerb(verbs) {\n            "update" == verbs[_]\n        }\n\n'})}),"\n",(0,s.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/block-endpoint-edit-default-role/template.yaml\n"})}),"\n",(0,s.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,s.jsxs)(t,{children:[(0,s.jsx)("summary",{children:"block-endpoint-default-role"}),(0,s.jsxs)(t,{children:[(0,s.jsx)("summary",{children:"constraint"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sBlockEndpointEditDefaultRole\nmetadata:\n  name: block-endpoint-edit-default-role\nspec:\n  match:\n    kinds:\n      - apiGroups: ["rbac.authorization.k8s.io"]\n        kinds: ["ClusterRole"]\n\n'})}),(0,s.jsx)(n.p,{children:"Usage"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/block-endpoint-edit-default-role/samples/block-endpoint-edit-default-role/constraint.yaml\n"})})]}),(0,s.jsxs)(t,{children:[(0,s.jsx)("summary",{children:"example-allowed"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  creationTimestamp: null\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    rbac.authorization.k8s.io/aggregate-to-edit: "true"\n  name: system:aggregate-to-edit\nrules:\n- apiGroups:\n  - ""\n  resources:\n  - pods/attach\n  - pods/exec\n  - pods/portforward\n  - pods/proxy\n  - secrets\n  - services/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - ""\n  resources:\n  - serviceaccounts\n  verbs:\n  - impersonate\n- apiGroups:\n  - ""\n  resources:\n  - pods\n  - pods/attach\n  - pods/exec\n  - pods/portforward\n  - pods/proxy\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - ""\n  resources:\n  - configmaps\n  - persistentvolumeclaims\n  - replicationcontrollers\n  - replicationcontrollers/scale\n  - secrets\n  - serviceaccounts\n  - services\n  - services/proxy\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - apps\n  resources:\n  - daemonsets\n  - deployments\n  - deployments/rollback\n  - deployments/scale\n  - replicasets\n  - replicasets/scale\n  - statefulsets\n  - statefulsets/scale\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - autoscaling\n  resources:\n  - horizontalpodautoscalers\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - batch\n  resources:\n  - cronjobs\n  - jobs\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - extensions\n  resources:\n  - daemonsets\n  - deployments\n  - deployments/rollback\n  - deployments/scale\n  - ingresses\n  - networkpolicies\n  - replicasets\n  - replicasets/scale\n  - replicationcontrollers/scale\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - policy\n  resources:\n  - poddisruptionbudgets\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - networking.k8s.io\n  resources:\n  - ingresses\n  - networkpolicies\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n\n'})}),(0,s.jsx)(n.p,{children:"Usage"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/block-endpoint-edit-default-role/samples/block-endpoint-edit-default-role/example_allowed.yaml\n"})})]}),(0,s.jsxs)(t,{children:[(0,s.jsx)("summary",{children:"example-disallowed"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  creationTimestamp: null\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n    rbac.authorization.k8s.io/aggregate-to-edit: "true"\n  name: system:aggregate-to-edit\nrules:\n- apiGroups:\n  - ""\n  resources:\n  - pods/attach\n  - pods/exec\n  - pods/portforward\n  - pods/proxy\n  - secrets\n  - services/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - ""\n  resources:\n  - serviceaccounts\n  verbs:\n  - impersonate\n- apiGroups:\n  - ""\n  resources:\n  - pods\n  - pods/attach\n  - pods/exec\n  - pods/portforward\n  - pods/proxy\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - ""\n  resources:\n  - configmaps\n  - persistentvolumeclaims\n  - replicationcontrollers\n  - replicationcontrollers/scale\n  - secrets\n  - serviceaccounts\n  - services\n  - services/proxy\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n- apiGroups:\n  - apps\n  resources:\n  - daemonsets\n  - deployments\n  - deployments/rollback\n  - deployments/scale\n  - endpoints\n  - replicasets\n  - replicasets/scale\n  - statefulsets\n  - statefulsets/scale\n  verbs:\n  - create\n  - delete\n  - deletecollection\n  - patch\n  - update\n\n'})}),(0,s.jsx)(n.p,{children:"Usage"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/block-endpoint-edit-default-role/samples/block-endpoint-edit-default-role/example_disallowed.yaml\n"})})]})]})]})}function p(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>r});var s=t(7294);const o={},a=s.createContext(o);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);